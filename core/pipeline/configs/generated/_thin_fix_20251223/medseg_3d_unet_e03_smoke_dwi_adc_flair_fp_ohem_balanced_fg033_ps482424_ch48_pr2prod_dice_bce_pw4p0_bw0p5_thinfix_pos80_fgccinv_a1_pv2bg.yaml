experiment_name: medseg_3d_unet_e03_smoke_dwi_adc_flair_fp_ohem_balanced_fg033_ps482424_ch48_pr2prod_dice_bce_pw4p0_bw0p5_thinfix_pos80_fgccinv_a1_pv2bg

data:
  csv_path: data/splits/my_dataset_dwi_adc_flair_train_val_test.csv
  root: data/processed/my_dataset_dwi_adc_flair
  modalities:
  - DWI
  - ADC
  - FLAIR
  normalize: nonzero_zscore
  patch_size:
  - 48
  - 48
  - 24
  val_stride:
  - 24
  - 24
  - 12
  val_threshold: auto
  val_min_size: 20
  val_threshold_candidates:
  - 0.3
  - 0.35
  - 0.4
  - 0.45
  - 0.5
  - 0.55
  - 0.6
  - 0.65
  - 0.7

  # PV2: sample 2 patches/volume and force one BG patch (to prevent FP explosion on all-positive splits)
  patches_per_volume: 2
  patches_force_one_bg: true

  # Sampling fix for small lesions
  foreground_prob: 0.33
  force_fg_prob: 0.0
  target_pos_patch_frac: 0.8
  fg_component_sampling: inverse_size
  fg_component_sampling_alpha: 1.0

  hard_bg_prob: 0.6
  hard_bg_trials: 512
  bg_inside_prob: 1.0
  bg_inside_trials: 128

  # With patches_force_one_bg, keep this off to avoid over-producing empty patches
  ensure_empty_bg_prob: 0.0
  ensure_empty_bg_trials: 512

train:
  batch_size: 1
  num_workers: 0
  epochs: 3
  max_steps_per_epoch: 80
  max_val_steps: 20
  lr: 0.0001
  min_lr: 1.0e-05
  weight_decay: 1.0e-05
  grad_clip: 1.0
  base_ch: 48
  loss: dice_bce
  loss_params:
    smooth: 1.0
    bce_weight: 0.5
    pos_weight: 4.0
  amp: true

log:
  out_dir: runs/3d_unet
  save_interval: 1
